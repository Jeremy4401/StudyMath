<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SME Launcher - ‚ùÑÔ∏è Snowy Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        /* =====================================
           [1] SNOWY GLASS THEME VARIABLES
        ===================================== */
        @font-face {
            font-family: "Comic Sans MS";
            src: local("Comic Sans MS");
        }

        :root {
            /* Snowy Day Palette */
            --color-sky-light: #e0f2f7;
            --color-sky-dark: #c0e0e8;
            --color-snow: #f8f8f8;
            --color-accent-blue: #66b2b2; /* Main highlight color */
            --color-text-dark: #33444c;
            --color-text-light: #5a7d8a;
            --color-glass-effect: rgba(255, 255, 255, 0.5); /* Semi-transparent white */
            --color-glass-border: rgba(255, 255, 255, 0.8);
            --color-bg-primary: linear-gradient(180deg, var(--color-sky-light) 0%, var(--color-sky-dark) 100%);
            --color-sidebar-bg: rgba(255, 255, 255, 0.7); /* Lighter sidebar */
            --color-button-hover: #7bd3d3; /* Lighter blue */
            --color-success: #4caf50;
            --color-error: #e53935;
            
            /* Glass card specific settings */
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        body {
            margin: 0;
            background: var(--color-bg-primary);
            color: var(--color-text-dark);
            font-family: "Comic Sans MS", cursive, sans-serif;
            overflow-x: hidden;
            background-attachment: fixed;
        }

        /* =====================================
           [2] SNOW BACKGROUND ANIMATION
        ===================================== */
        #snow-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .snowflake {
            position: absolute;
            background: var(--color-snow);
            border-radius: 50%;
            pointer-events: none;
            animation: fall linear infinite;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.7);
            opacity: 0;
            filter: blur(0.5px);
        }

        @keyframes fall {
            0% {
                opacity: 0;
                transform: translateY(-10vh) scale(0.8);
            }
            5% {
                opacity: 0.9;
            }
            100% {
                opacity: 0;
                transform: translateY(110vh) scale(1.2);
            }
        }
        
        /* =====================================
           [3] BASE STYLES AND LAYOUT
        ===================================== */

        /* SIDEBAR (Standardized Navigation) */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 75px;
            height: 100%;
            background: var(--color-sidebar-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--color-glass-border);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        }

        #sidebar div {
            padding: 15px;
            cursor: pointer;
            text-align: center;
            font-size: 24px;
            transition: 0.2s;
            color: var(--color-text-dark);
        }

        #sidebar div:hover, .sidebar-active {
            transform: scale(1.1);
            background: rgba(102, 178, 178, 0.2);
            border-radius: 8px;
            color: var(--color-accent-blue);
        }

        /* MAIN */
        #main {
            margin-left: 90px;
            padding: 20px;
            z-index: 5;
            position: relative;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .section.active {
            display: block;
        }

        /* CARD STYLES */
        .homeCard, .card {
            background: var(--color-glass-effect);
            backdrop-filter: blur(8px);
            border: 1px solid var(--color-glass-border);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease-out, box-shadow 0.3s;
        }

        .card {
            width: 260px;
            height: 380px;
            margin: 10px;
            border-left: 5px solid var(--color-accent-blue);
        }
        
        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 178, 178, 0.3);
        }

        h2, h3 {
            color: var(--color-accent-blue);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Buttons (Blue/Accent theme) */
        .tabBtn {
            padding: 10px 16px;
            border-radius: 20px;
            border: 2px solid var(--color-accent-blue);
            background: var(--color-accent-blue);
            color: var(--color-snow);
            font-weight: bold;
            transition: 0.2s;
            cursor: pointer;
        }

        .tabBtn:hover {
            background: var(--color-button-hover); 
            border-color: var(--color-button-hover);
            transform: translateY(-1px);
        }
        
        /* Home Button (Matching glass style) */
        #homeBtn {
            background: var(--color-glass-effect);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-glass-border);
            color: var(--color-accent-blue);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
            z-index: 100;
        }
        #homeBtn:hover {
            transform: scale(1.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input Styles */
        input[type="text"], textarea {
            padding: 10px;
            border: 1px solid var(--color-glass-border);
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--color-text-dark);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 3px rgba(102, 178, 178, 0.3);
            outline: none;
        }
        
        /* Game Categories */
        #gameCategoryTabs {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .category-tab {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--color-glass-border);
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            color: var(--color-text-dark);
        }
        .category-tab.active {
            background: var(--color-accent-blue);
            color: var(--color-snow);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div id="snow-layer"></div>

    <div id="sidebar">
        <div onclick="nav('homeDashboard')">üè†</div>
        <div onclick="nav('games')">üéÆ</div>
        <div onclick="nav('friends')">üë•</div>
        <div onclick="nav('profile')">üë§</div> 
        <div onclick="openSettings()">‚öôÔ∏è</div>
        <div onclick="window.location.href='theater.html'">üé¨</div>
        <div onclick="window.location.href='requests.html'">üìÆ</div>
        <div onclick="window.location.href='proxies.html'">üåê</div> 
        <div onclick="panic()">‚ö†</div>
    </div>

    <div id="homeBtn" onclick="exitGame()">üè†</div>

    <div id="main">
        <h1 id="pageTitle">Home</h1>

        <div id="homeDashboard" class="section active">
            <div class="homeCard">
                <h2>‚ùÑÔ∏è Welcome to the Snowy Launcher!</h2>
                <p>Enjoy the clean, glassy aesthetic and chat with friends.</p>
            </div>

            <div id="socialFeed" class="homeCard">
                <h3>Social Feed</h3>
                <div id="feedPosts"></div>
                <textarea
                    id="feedInput"
                    placeholder="Share something..."
                    style="width:100%;height:60px;padding:10px;margin-top:10px;"
                ></textarea>
                <button
                    onclick="postToFeed()"
                    class="tabBtn"
                    style="width:100%;margin-top:8px;"
                >
                    Post
                </button>
            </div>

            <div id="friendsOnline" class="homeCard">
                <h3>Friends Online</h3>
                <div id="onlineList"></div>
            </div>

            <div id="activityLog" class="homeCard">
                <h3>Recent Activity</h3>
                <div id="activityList"></div>
            </div>
        </div>

        <div id="games" class="section">
            <h2>Game Library</h2>
            <div id="gameCategoryTabs">
                <div class="category-tab active" data-category="All" onclick="filterGames('All', this)">All Games</div>
                <div class="category-tab" data-category="Action" onclick="filterGames('Action', this)">Action</div>
                <div class="category-tab" data-category="Strategy" onclick="filterGames('Strategy', this)">Strategy</div>
                <div class="category-tab" data-category="Classic" onclick="filterGames('Classic', this)">Classic</div>
                <div class="category-tab" data-category="Unblocked" onclick="filterGames('Unblocked', this)">Unblocked</div>
            </div>
            <div id="gameList" style="display:flex; flex-wrap:wrap;">
                </div>
        </div>
        
        <div id="friends" class="section">
            <h2>Friends & Messages</h2>
            <div class="homeCard">
                <h3>Your Friend Code</h3>
                <p>Share this code to be added by others.</p>
                <code id="displayFriendCode" style="font-size:1.2em; color:var(--color-accent-blue);">Loading...</code>
                <button onclick="copyFriendCode()" class="tabBtn" style="margin-left:10px;">Copy Code</button>
                <div id="authStatus" style="margin-top:10px; font-size:12px; color:var(--color-text-light);">Not Logged In. Cannot use online features.</div>
            </div>
            <div class="homeCard">
                <h3>Send Friend Request</h3>
                <input type="text" id="friendCodeInput" placeholder="Enter Friend Code (e.g., SME-A1B2C3)" style="padding:10px; width:200px; margin-right: 10px;">
                <button onclick="sendFriendRequest()" class="tabBtn">Send Request</button>
            </div>
            <div id="chatWindow" class="homeCard" style="display:none;">
                 </div>
        </div>

        <div id="profile" class="section">
            <h2>üë§ User Profile</h2>
            <div class="homeCard">
                <h3>Your Account Information</h3>
                <p>Status: Logged In</p>
                <p>Username: <span id="currentUsername">Loading...</span></p>
                <p>Friend Code: <code id="displayFriendCode">Loading...</code></p>
            </div>
            <div class="homeCard">
                <h3>Achievements</h3>
                <p>No achievements unlocked yet.</p>
            </div>
        </div>
        
        <div id="settingsPage" class="section">
            <h2>‚öôÔ∏è Settings</h2>
            <div id="settingsContent" class="homeCard">
                </div>
        </div>
        
    </div>

    <div id="embedWin">
        <iframe id="embedFrame"></iframe>
    </div>

    <div id="gameModal" style="display:none; position:fixed; inset:0; background:rgba(0, 0, 0, 0.5); z-index:9999; align-items:center; justify-content:center;">
        <div id="modalBox" class="homeCard" style="width:420px; padding:20px; box-shadow:0 0 30px rgba(102, 178, 178, 0.4);">
            <img id="modalImg" src="" style="width:100%;border-radius:10px;" />
            <h2 id="modalTitle"></h2>
            <p id="modalDesc"></p>
            <div id="playtimeBox" style="margin-top:10px;"></div>
            <button id="playBtn" class="tabBtn" style="width:100%;margin-top:10px;">Play</button>
            <button onclick="closeGameModal()" class="tabBtn" style="background:#aaa; border-color:#aaa; width:100%; margin-top:10px;">Close</button>
        </div>
    </div>
    
    <div id="friendProfileModal" style="display:none; position:fixed; inset:0; background:rgba(0, 0, 0, 0.7); z-index:9999; align-items:center; justify-content:center;">
        <div class="homeCard" style="width:350px; padding:20px;">
            <button onclick="closeFriendProfileModal()" style="float:right; background:none; border:none; color:var(--color-text-dark); font-size:1.5em; cursor:pointer;">&times;</button>
            <div class="profileBanner" style="height:60px; background: var(--color-accent-blue);"></div>
            <div id="modalFriendAvatar" class="profileAvatar" style="margin-top:-30px; background-size:cover;"></div>
            <h2 id="modalFriendUsername" style="margin-top:10px;"></h2>
            <p id="modalFriendStatus" style="color:var(--color-success);">Online</p>
            <p id="modalFriendBio" style="margin-top:10px; opacity:0.8;"></p>
            <button id="modalMessageBtn" onclick="openChatFromProfile()" class="tabBtn" style="margin-top:15px; width:100%;">Message</button>
        </div>
    </div>
    <script type="module">
        // ============================
        // FIREBASE INIT (V12 MODULES)
        // ============================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // >>> YOUR FIREBASE CONFIGURATION (UNCHANGED) <<<
        const firebaseConfig = {
            apiKey: "AIzaSyBxXsXA1aoOLzDD-yNaZnHETgxPAJ-mbjw",
            authDomain: "sme-loader.firebaseapp.com",
            databaseURL: "https://sme-loader-default-rtdb.firebaseio.com",
            projectId: "sme-loader",
            storageBucket: "sme-loader.firebasestorage.app",
            messagingSenderId: "427113600756",
            appId: "1:427113600756:web:73227a309d4a2e6c51b0a1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let friendCode = localStorage.getItem("friendCode");

        function notify(message) { alert(message); }

        // ============================
        // FIREBASE AUTH & USER SETUP
        // ============================
        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                currentUserId = user.uid;
                if (!friendCode) {
                    friendCode = `SME-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                    localStorage.setItem("friendCode", friendCode);
                }
                
                const username = localStorage.getItem("username") || `User${Math.floor(Math.random() * 10000)}`;

                await setDoc(doc(db, "users", currentUserId), {
                    username: username,
                    friendCode: friendCode,
                    lastSeen: serverTimestamp(),
                    isOnline: true,
                }, { merge: true });

                document.getElementById("currentUsername").textContent = username;
                document.getElementById("displayFriendCode").textContent = friendCode;
                document.getElementById("authStatus").textContent = `Logged in as: ${username}`;

                // setupFriendsListener(); // Place your actual listener calls here
                // setupRequestsListener();

            } else {
                currentUserId = null;
                signInAnonymously(auth).catch(error => { console.error("Anonymous sign-in failed:", error); });
            }
        });
        
        window.addEventListener('beforeunload', () => {
             if (currentUserId) {
                updateDoc(doc(db, "users", currentUserId), { isOnline: false });
            }
        });

        // ============================
        // CORE NAVIGATION AND UTILITIES
        // ============================

        function nav(id) {
            document.querySelectorAll(".section").forEach((s) => s.classList.remove("active"));
            const target = document.getElementById(id);
            if (target) target.classList.add("active");

            const titleMap = {
                homeDashboard: "Home", games: "Game Library", friends: "Friends & Messages",
                profile: "User Profile", settingsPage: "Settings"
            };
            document.getElementById("pageTitle").textContent = titleMap[id] || "SME";
            
            if (id === 'games') renderGameList('All');
        }
        
        // Initial navigation
        nav('homeDashboard');
        
        function openSettings() {
             document.getElementById('settingsContent').innerHTML = `
                <h3>User Settings</h3>
                <label for="setUsername">Change Username:</label>
                <input type="text" id="setUsername" placeholder="Enter new username" value="${localStorage.getItem("username") || ''}" style="width:100%; margin-bottom:15px;">
                <button onclick="saveUsername()" class="tabBtn">Save Username</button>
                <hr style="margin: 20px 0; border-color: rgba(255, 255, 255, 0.5);">
                <h3>Launcher Options</h3>
                <p>More options coming soon!</p>
            `;
            nav('settingsPage');
        }
        
        window.saveUsername = function() {
            const newUsername = document.getElementById('setUsername').value.trim();
            if (newUsername) {
                localStorage.setItem("username", newUsername);
                if (currentUserId) {
                    updateDoc(doc(db, "users", currentUserId), { username: newUsername });
                }
                document.getElementById("currentUsername").textContent = newUsername;
                notify(`Username updated to: ${newUsername}`);
            } else {
                notify("Username cannot be empty.");
            }
        }

        window.exitGame = function() {
            document.getElementById("embedWin").style.display = 'none';
            document.getElementById("embedFrame").src = '';
            document.getElementById("homeBtn").style.display = 'none';
        }

        window.panic = function() {
            location.href = "https://classroom.google.com";
        }

        window.loadEmbed = function(url) {
            document.getElementById("embedFrame").src = url;
            document.getElementById("embedWin").style.display = 'block';
            document.getElementById("homeBtn").style.display = 'flex';
            closeGameModal();
        }

        window.closeGameModal = function() {
            document.getElementById('gameModal').style.display = 'none';
        }

        // Placeholder functions for friend/feed features
        window.copyFriendCode = function() { 
            navigator.clipboard.writeText(friendCode).then(() => { notify("Friend code copied!"); });
        }
        window.sendFriendRequest = function() { notify("Friend Request feature is active!"); }
        window.postToFeed = function() { notify("Social feed is active!"); }
        window.openChatFromProfile = function() { notify("Chat is active!"); }


        // ============================
        // GAME LOGIC (FIXED CATEGORIES)
        // ============================
        
        const gameData = [
            { id: 1, title: "Action Shooter", category: "Action", url: "url1", image: "https://via.placeholder.com/260x160?text=Action+Game", description: "Fast-paced shooting action." },
            { id: 2, title: "Chess Master", category: "Strategy", url: "url2", image: "https://via.placeholder.com/260x160?text=Chess+Game", description: "A timeless game of strategy." },
            { id: 3, title: "Retro Arcade", category: "Classic", url: "url3", image: "https://via.placeholder.com/260x160?text=Retro+Arcade", description: "Old school fun." },
            { id: 4, title: "Cool Math Game", category: "Unblocked", url: "url4", image: "https://via.placeholder.com/260x160?text=Unblocked+Fun", description: "A popular unblocked game." },
            { id: 5, title: "Tower Defense", category: "Strategy", url: "url5", image: "https://via.placeholder.com/260x160?text=Tower+Defense", description: "Defend your base!" },
            { id: 6, title: "Fighting Arena", category: "Action", url: "url6", image: "https://via.placeholder.com/260x160?text=Fighting+Game", description: "One vs one combat." },
            { id: 7, title: "Snake", category: "Classic", url: "url7", image: "https://via.placeholder.com/260x160?text=Classic+Snake", description: "The original time-waster." },
        ];
        
        function renderGameCard(game) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${game.image}" alt="${game.title}" width="100%" height="160px">
                <h3 style="margin-top:10px; margin-bottom:5px;">${game.title}</h3>
                <p style="font-size:0.9em; color:var(--color-text-light);">${game.description.substring(0, 50)}...</p>
                <p style="font-size:0.8em; font-style:italic;">Category: ${game.category}</p>
                <button class="tabBtn" style="width:100%; margin-top:10px;" onclick="openGameModal(${game.id})">Details</button>
            `;
            return card;
        }

        window.filterGames = function(category, element) {
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            renderGameList(category);
        }

        function renderGameList(category) {
            const listContainer = document.getElementById('gameList');
            listContainer.innerHTML = '';
            
            const filteredGames = category === 'All' 
                ? gameData 
                : gameData.filter(game => game.category === category);

            if (filteredGames.length === 0) {
                listContainer.innerHTML = `<p class="homeCard" style="width:90%;">No games found in the ${category} category.</p>`;
                return;
            }

            filteredGames.forEach(game => {
                listContainer.appendChild(renderGameCard(game));
            });
        }
        
        window.openGameModal = function(gameId) {
            const game = gameData.find(g => g.id === gameId);
            if (!game) return;

            document.getElementById('modalImg').src = game.image;
            document.getElementById('modalTitle').textContent = game.title;
            document.getElementById('modalDesc').textContent = game.description;
            document.getElementById('playBtn').onclick = () => loadEmbed(game.url);

            document.getElementById('gameModal').style.display = 'flex';
        }


        // ============================
        // SNOWFLAKES (RE-INIT)
        // ============================
        const snowLayer = document.getElementById('snow-layer');
        function createSnowflake() {
            const s = document.createElement("div");
            s.classList.add("snowflake");
            s.style.width = s.style.height = Math.random() * 4 + 1 + "px";
            s.style.top = Math.random() * -10 + "vh";
            s.style.left = Math.random() * 100 + "vw";
            s.style.animationDuration = Math.random() * 12 + 8 + "s";
            s.style.animationDelay = Math.random() * 6 + "s";
            s.style.zIndex = Math.floor(Math.random() * 5);

            snowLayer.appendChild(s);
            setTimeout(() => s.remove(), 20000);
        }
        setInterval(createSnowflake, 150);

        // Render initial game list
        renderGameList('All');
    </script>
</body>
</html>
